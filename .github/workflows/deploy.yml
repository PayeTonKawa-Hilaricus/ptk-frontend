name: ğŸš€ Deploy Frontend to PC2

on:
  push:
    branches: ["main"]

jobs:
  deploy-pc2:
    name: ğŸ“¦ Build & Deploy
    runs-on: [self-hosted, production-pc]

    steps:
      - name: ğŸšš Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”„ Update & Restart Frontend
        shell: powershell
        run: |
          # Configuration des chemins
          $ROOT = "C:\PayeTonKawa"
          $FRONTEND_DIR = "$ROOT\ptk-frontend"
          $INFRA_DIR = "$ROOT\ptk-infrastructure"

          Write-Host "ğŸš€ DEBUT DU DEPLOIEMENT FRONTEND"

          # 1. Mise Ã  jour du code FRONTEND
          if (-not (Test-Path $FRONTEND_DIR)) {
            cd $ROOT
            git clone https://github.com/PayeTonKawa-Hilaricus/ptk-frontend.git
          }
          cd $FRONTEND_DIR
          git fetch origin
          git reset --hard origin/main

          # 2. Mise Ã  jour de l'INFRASTRUCTURE (C'est ici qu'il manquait le pull !)
          Write-Host "ğŸ”„ Mise Ã  jour du docker-compose.yml..."
          cd $INFRA_DIR
          git fetch origin
          git reset --hard origin/main

          # 3. Lancement de Docker
          Write-Host "ğŸ³ Reconstruction du conteneur..."
          # On relance le frontend
          docker compose up -d --build --no-deps ptk-frontend

          docker image prune -f

          Write-Host "âœ… DEPLOIEMENT REUSSI : http://localhost:8080"
