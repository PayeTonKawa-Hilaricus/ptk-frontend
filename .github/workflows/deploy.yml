name: ðŸš€ Deploy Frontend to PC2

on:
  push:
    branches: ["main"]

jobs:
  deploy-pc2:
    name: ðŸ“¦ Build & Deploy
    runs-on: [self-hosted, production-pc] # Ton runner sur PC2

    steps:
      - name: ðŸšš Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”„ Update & Restart Frontend
        shell: powershell
        run: |
          # Configuration des chemins
          $ROOT = "C:\PayeTonKawa"
          $FRONTEND_DIR = "$ROOT\ptk-frontend"
          $INFRA_DIR = "$ROOT\ptk-infrastructure"

          Write-Host "ðŸš€ DEBUT DU DEPLOIEMENT FRONTEND"

          # 1. On met Ã  jour le code source du Frontend
          if (-not (Test-Path $FRONTEND_DIR)) {
            # Si le dossier n'existe pas encore, on le clone
            cd $ROOT
            git clone https://github.com/TonPseudo/ptk-frontend.git
          }

          cd $FRONTEND_DIR
          git fetch origin
          git reset --hard origin/main

          # 2. On va dans l'infra pour lancer la reconstruction Docker
          cd $INFRA_DIR

          # On reconstruit l'image et on relance le conteneur
          # --no-deps Ã©vite de relancer les autres services (Auth, Products, etc.)
          docker compose up -d --build --no-deps ptk-frontend

          # Nettoyage des vieilles images pour gagner de la place
          docker image prune -f

          Write-Host "âœ… DEPLOIEMENT REUSSI : http://localhost:8080"
